<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:700px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
select,button{width:48%;padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5px}
button{background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:420px;overflow:auto;text-align:left}
h2{margin:0 0 12px 0}
.note{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
<div id="walletApp">
  <h2>Universal Solana Wallet DApp (Helius)</h2>

  <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
    <select id="walletSelect"><option value="">Select Wallet</option></select>
  </div>

  <div style="text-align:center">
    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet">Disconnect Wallet</button>
    <button id="reclaimRentBtn">🧹 Reclaim Rent</button>
  </div>

  <div class="note">Using Helius RPC (demo key) — do not commit private keys to public repos.</div>
  <div id="logs">Logs will appear here...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>

<script>
(async function() {
  const HELIUS_RPC = 'https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
  const TOKEN_PROGRAM = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
  const DUST_THRESHOLD_USD = 0.01; // treat accounts < $0.01 as empty/dust

  const walletSelect = document.getElementById('walletSelect');
  const connectBtn = document.getElementById('connectWallet');
  const disconnectBtn = document.getElementById('disconnectWallet');
  const reclaimBtn = document.getElementById('reclaimRentBtn');
  const logsEl = document.getElementById('logs');

  let wallet = null;
  let publicKey = null;
  let connection = null;

  function log(msg){
    console.log(msg);
    logsEl.innerText += msg + '\n';
    logsEl.scrollTop = logsEl.scrollHeight;
  }

  function clearLogs(){ logsEl.innerText=''; }

  function detectWallets() {
    const wallets = [];
    if(window.phantom?.solana?.isPhantom) wallets.push({wallet: window.phantom.solana, name:'Phantom'});
    if(window.solflare && window.solflare.isSolflare) wallets.push({wallet: window.solflare, name:'Solflare'});
    if(window.Slope){ try { wallets.push({wallet: new window.Slope(), name:'Slope'}); } catch(e){} }
    return wallets;
  }

  function populateWalletDropdown() {
    walletSelect.innerHTML = '<option value="">Select Wallet</option>';
    const detected = detectWallets();
    detected.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w.name;
      opt.textContent = w.name;
      walletSelect.appendChild(opt);
    });
    if(detected.length === 0) log('❌ No wallets detected. Install Phantom, Solflare, or Slope.');
    else log('Detected wallets: ' + detected.map(d=>d.name).join(', '));
  }

  function getSelectedWallet() {
    const name = walletSelect.value;
    return detectWallets().find(w=>w.name===name);
  }

  function buildConnection() {
    try {
      return new solanaWeb3.Connection(HELIUS_RPC, 'confirmed');
    } catch(e){
      log('❌ RPC connection failed: '+e.message);
      throw e;
    }
  }

  async function connectWalletFunc(){
    clearLogs();
    const sel = getSelectedWallet();
    if(!sel){ log('❌ Select a wallet first'); return; }
    try {
      log('Connecting ' + sel.name + '...');
      const resp = await sel.wallet.connect();
      publicKey = resp?.publicKey || sel.wallet?.publicKey;
      if(publicKey?.toString) publicKey = publicKey.toString();
      wallet = sel.wallet;
      log('Connected: ' + publicKey);

      if(!connection) connection = buildConnection();

      // SOL balance
      const lamports = await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
      log('💰 SOL Balance: ' + (lamports/1e9).toFixed(6) + ' SOL');

      // SPL token accounts
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        new solanaWeb3.PublicKey(publicKey),
        { programId: new solanaWeb3.PublicKey(TOKEN_PROGRAM) }
      );

      if(!tokenAccounts?.value?.length) log('No SPL tokens found.');
      else tokenAccounts.value.forEach((t,i)=>{
        const info = t.account.data.parsed.info;
        log(`${i+1}. Mint: ${info.mint}, Amount: ${info.tokenAmount.uiAmountString}`);
      });
    } catch(err){ log('❌ Connect failed: '+err.message); }
  }

  async function disconnectWalletFunc(){
    if(!wallet){ log('❌ No wallet connected'); return; }
    try {
      if(wallet.disconnect) await wallet.disconnect();
      log('Wallet disconnected');
      wallet=null; publicKey=null;
    } catch(err){ log('❌ Disconnect error: '+err.message); }
  }

  async function getTokenPrices(mints){
    if(!mints.length) return {};
    const res = await fetch('https://api.helius.xyz/v0/token-prices?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({mints})
    });
    const data = await res.json();
    const map = {};
    data.forEach(p=>map[p.mint]=p.price || 0);
    return map;
  }

  async function reclaimRent(){
    if(!wallet || !publicKey){ log('❌ Connect wallet first.'); return; }
    clearLogs();
    log('🧹 Reclaim Rent started...');

    // fetch token accounts
    let tokenAccounts;
    try {
      tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        new solanaWeb3.PublicKey(publicKey),
        { programId: new solanaWeb3.PublicKey(TOKEN_PROGRAM) }
      );
    } catch(e){ log('❌ Fetch token accounts failed: '+e.message); return; }

    if(!tokenAccounts?.value?.length){ log('✅ No token accounts found.'); return; }

    // query prices
    const mints = tokenAccounts.value.map(t=>t.account.data.parsed.info.mint);
    const priceMap = await getTokenPrices(mints);

    // filter empty/dust
    const empty = tokenAccounts.value.filter(t=>{
      const amount = Number(t.account.data.parsed.info.tokenAmount.uiAmount);
      const mint = t.account.data.parsed.info.mint;
      const price = priceMap[mint] || 0;
      const usdValue = amount*price;
      return usdValue < DUST_THRESHOLD_USD;
    });

    if(empty.length===0){ log('✅ No empty/dust token accounts to reclaim.'); return; }
    log(`🪣 Found ${empty.length} empty/dust token account(s). Closing...`);

    for(const entry of empty){
      const tokenPub = entry.pubkey;
      try{
        const keys=[
          {pubkey: tokenPub,isSigner:false,isWritable:true},
          {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:false,isWritable:true},
          {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:true,isWritable:false}
        ];
        const ix = new solanaWeb3.TransactionInstruction({keys,programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM),data:Buffer.from([9])});
        const tx = new solanaWeb3.Transaction().add(ix);
        tx.feePayer = new solanaWeb3.PublicKey(publicKey);
        const {blockhash} = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;

        let sig;
        if(wallet.signTransaction){
          const signedTx = await wallet.signTransaction(tx);
          sig = await connection.sendRawTransaction(signedTx.serialize());
        } else if(wallet.signAndSendTransaction){
          const res = await wallet.signAndSendTransaction(tx);
          sig = res?.signature || res;
        } else { throw new Error('Wallet cannot sign transaction'); }

        await connection.confirmTransaction(sig,'confirmed');
        log(`✅ Closed ${tokenPub.toString()} — tx ${sig}`);
      } catch(err){ log(`❌ Failed ${tokenPub.toString()}: ${err?.message||String(err)}`); }
    }
    log('🎉 Reclaim run complete.');
  }

  // button listeners
  connectBtn.addEventListener('click', connectWalletFunc);
  disconnectBtn.addEventListener('click', disconnectWalletFunc);
  reclaimBtn.addEventListener('click', reclaimRent);

  // init
  connection = buildConnection();
  populateWalletDropdown();
  setInterval(()=>{
    const detected = detectWallets();
    if(detected.length + 1 !== walletSelect.options.length) populateWalletDropdown();
  },3000);

})();
</script>
</body>
</html>
