<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:700px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
select,button{width:48%;padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5px}
button{background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:420px;overflow:auto;text-align:left}
h2{margin:0 0 12px 0}
.note{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
<div id="walletApp">
  <h2>Universal Solana Wallet DApp (Helius)</h2>

  <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
    <select id="walletSelect"><option value="">Select Wallet</option></select>
  </div>

  <div style="text-align:center">
    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet">Disconnect Wallet</button>
    <button id="reclaimRentBtn">🧹 Reclaim Rent</button>
  </div>

  <div class="note">Using Helius RPC (demo key) — do not commit private keys to public repos.</div>
  <div id="logs">Logs will appear here...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>

<script>
(function () {
  const HELIUS_RPC = 'https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
  const FALLBACK_RPC = 'https://solana-api.projectserum.com';
  const TOKEN_PROGRAM = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';

  const logsEl = document.getElementById('logs');
  const walletSelect = document.getElementById('walletSelect');
  const connectBtn = document.getElementById('connectWallet');
  const disconnectBtn = document.getElementById('disconnectWallet');
  const reclaimBtn = document.getElementById('reclaimRentBtn');

  let wallet = null;
  let publicKey = null;
  let connection = null;

  function logStep(msg) {
    console.log(msg);
    logsEl.innerText += msg + '\n';
    logsEl.scrollTop = logsEl.scrollHeight;
  }

  function waitForWeb3(timeoutMs = 5000) {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      (function poll() {
        const g = window.solanaWeb3 || window.web3 || window.web3js || window.solanaWeb3js;
        if (g) return resolve(g);
        if (Date.now() - start > timeoutMs) return reject(new Error('web3 global not found'));
        setTimeout(poll, 150);
      })();
    });
  }

  function detectWallets() {
    const out = [];
    if (window.phantom?.solana?.isPhantom) out.push({ wallet: window.phantom.solana, name: 'Phantom' });
    if (window.solana && window.solana.isPhantom && !out.find(x=>x.name==='Phantom')) out.push({ wallet: window.solana, name: 'Phantom' });
    if (window.solflare && window.solflare.isSolflare) out.push({ wallet: window.solflare, name: 'Solflare' });
    if (window.Slope) { try { out.push({ wallet: new window.Slope(), name: 'Slope' }); } catch(e) {} }
    return out;
  }

  function populateWalletDropdown() {
    walletSelect.innerHTML = '<option value="">Select Wallet</option>';
    const detected = detectWallets();
    detected.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w.name;
      opt.textContent = w.name;
      walletSelect.appendChild(opt);
    });
    logStep('Detected wallets: ' + detected.map(d => d.name).join(', '));
  }

  function getSelectedWallet() {
    const name = walletSelect.value;
    return detectWallets().find(w => w.name === name);
  }

  function buildConnection(web3Global) {
    try { return new web3Global.Connection(HELIUS_RPC, 'confirmed'); }
    catch(e) { logStep('⚠️ Helius RPC failed, falling back: ' + e.message); }
    try { const g = window.solanaWeb3 || window.web3 || window.web3js || window.solanaWeb3js; return new g.Connection(FALLBACK_RPC, 'confirmed'); }
    catch(e) { logStep('❌ Cannot create RPC: '+e.message); throw e; }
  }

  async function init() {
    try {
      const web3Global = await waitForWeb3(7000).catch(() => window.solanaWeb3 || window.web3 || window.web3js || window.solanaWeb3js);
      if (!web3Global) { logStep('❌ web3 not found'); return; }
      logStep('✅ web3 loaded');
      connection = buildConnection(web3Global);
      logStep('✅ RPC ready');
      populateWalletDropdown();
    } catch(e){ logStep('❌ Init error: '+e.message); console.error(e); }
  }

  async function connectWalletFunc() {
    logsEl.innerText = '';
    const wObj = getSelectedWallet();
    if (!wObj) { logStep('❌ Select a wallet first'); return; }
    try {
      logStep('Connecting ' + wObj.name + '...');
      const resp = await wObj.wallet.connect();
      publicKey = resp?.publicKey || wObj.wallet?.publicKey;
      if (publicKey && publicKey.toString) publicKey = publicKey.toString();
      logStep('Connected: ' + publicKey);

      // SOL Balance
      const lamports = await connection.getBalance(new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey));
      logStep('💰 SOL Balance: ' + (lamports / 1e9).toFixed(6) + ' SOL');

      // SPL Tokens
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey),
        { programId: new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(TOKEN_PROGRAM) }
      );
      if (!tokenAccounts?.value?.length) logStep('No SPL tokens found.');
      else tokenAccounts.value.forEach((t,i)=>{
        try {
          const info = t.account.data.parsed.info;
          logStep(`${i+1}. Mint: ${info.mint}, Amount: ${info.tokenAmount.uiAmountString}`);
        } catch(e){ logStep(`${i+1}. Token account (raw): ${JSON.stringify(t)}`); }
      });

      wallet = wObj.wallet;
    } catch(err){ logStep('❌ Connect error: '+err.message); console.error(err); }
  }

  async function disconnectWalletFunc() {
    if (!wallet) { logStep('❌ No wallet connected'); return; }
    try { await wallet.disconnect(); logStep('Wallet disconnected'); wallet=null; publicKey=null; }
    catch(err){ logStep('❌ Disconnect error: '+err.message); console.error(err); }
  }

  // ---------- Reclaim Rent ----------
  async function reclaimRentFunc() {
    logsEl.innerText = '';
    if (!wallet) await connectWalletFunc();
    if (!wallet) return;

    try {
      logStep('🧹 Reclaim Rent started...');
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey),
        { programId: new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(TOKEN_PROGRAM) }
      );
      const empty = tokenAccounts.value.filter(t=>Number(t.account.data.parsed.info.tokenAmount.uiAmount)===0);
      if(empty.length===0){ logStep('✅ No empty token accounts'); return; }

      logStep(`🪣 Found ${empty.length} empty accounts, closing...`);
      for(const t of empty){
        const keys=[
          {pubkey:t.pubkey,isSigner:false,isWritable:true},
          {pubkey:new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey),isSigner:false,isWritable:true},
          {pubkey:new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey),isSigner:true,isWritable:false}
        ];
        const ix = new (window.solanaWeb3 || window.web3 || window.web3js).TransactionInstruction({keys,programId:new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(TOKEN_PROGRAM),data:Buffer.from([9])});
        const tx = new (window.solanaWeb3 || window.web3 || window.web3js).Transaction().add(ix);
        tx.feePayer = new (window.solanaWeb3 || window.web3 || window.web3js).PublicKey(publicKey);
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;

        let sig;
        if(wallet.signTransaction){ const s=await wallet.signTransaction(tx); sig=await connection.sendRawTransaction(s.serialize()); }
        else if(wallet.signAndSendTransaction){ const s=await wallet.signAndSendTransaction(tx); sig=s?.signature||s; }
        await connection.confirmTransaction(sig,'confirmed');
        logStep(`✅ Closed ${t.pubkey.toString()} — tx ${sig}`);
      }
      logStep('🎉 Reclaim run complete.');
    } catch(err){
      logStep('❌ Reclaim error: ' + (err?.message||String(err)));
      console.error(err);
    }
  }

  // Wire buttons
  connectBtn.addEventListener('click', connectWalletFunc);
  disconnectBtn.addEventListener('click', disconnectWalletFunc);
  reclaimBtn.addEventListener('click', reclaimRentFunc);

  // Init
  init();

  // Refresh wallet dropdown periodically (detect new wallets)
  setInterval(()=>{
    const had = walletSelect.options.length;
    const detected = detectWallets();
    if(detected.length + 1 !== had){ populateWalletDropdown(); }
  }, 3000);

})();
</script>
</body>
</html>
