<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:700px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
button,select{padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5px}
button{background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:420px;overflow:auto;text-align:left}
#tokenList{margin-top:12px;border:1px solid #ddd;border-radius:8px;padding:8px;max-height:250px;overflow:auto;background:#fafafa;text-align:left}
.token-item{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.note{font-size:13px;color:#666;margin-top:8px}
h2{margin:0 0 12px 0}
</style>
</head>
<body>
<div id="walletApp">
  <h2>Universal Solana Wallet DApp (Helius)</h2>
  <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
    <select id="walletSelect"><option value="">Select Wallet</option></select>
  </div>
  <div style="text-align:center">
    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet">Disconnect Wallet</button>
    <button id="reclaimRentBtn">🧹 Reclaim Selected</button>
  </div>
  <div id="tokenList">No tokens loaded.</div>
  <div class="note">Using Helius RPC (demo key) — never share private keys.</div>
  <div id="logs">Logs will appear here...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>

<script>
(async function(){
const HELIUS_RPC='https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
const TOKEN_PROGRAM='TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';

const logsEl=document.getElementById('logs');
const walletSelect=document.getElementById('walletSelect');
const connectBtn=document.getElementById('connectWallet');
const disconnectBtn=document.getElementById('disconnectWallet');
const reclaimBtn=document.getElementById('reclaimRentBtn');
const tokenList=document.getElementById('tokenList');

let wallet=null;
let publicKey=null;
let connection=new solanaWeb3.Connection(HELIUS_RPC,'confirmed');
let tokenAccounts=[];

function log(msg){ logsEl.innerText+=msg+'\n'; logsEl.scrollTop=logsEl.scrollHeight; console.log(msg); }
function clearLogs(){ logsEl.innerText=''; }

function detectWallets(){
  const wallets=[];
  if(window.phantom?.solana?.isPhantom) wallets.push({wallet:window.phantom.solana,name:'Phantom'});
  if(window.solflare?.isSolflare) wallets.push({wallet:window.solflare,name:'Solflare'});
  if(window.Slope){try{wallets.push({wallet:new window.Slope(),name:'Slope'});}catch{}}
  return wallets;
}
function populateWalletDropdown(){
  walletSelect.innerHTML='<option value="">Select Wallet</option>';
  detectWallets().forEach(w=>{
    const opt=document.createElement('option');
    opt.value=w.name; opt.textContent=w.name;
    walletSelect.appendChild(opt);
  });
}
function getSelectedWallet(){const n=walletSelect.value;return detectWallets().find(w=>w.name===n);}

async function connectWalletFunc(){
  clearLogs();
  const sel=getSelectedWallet();
  if(!sel){log('❌ Select a wallet first');return;}
  try{
    log('Connecting '+sel.name+'...');
    const resp=await sel.wallet.connect();
    publicKey=(resp?.publicKey||sel.wallet?.publicKey).toString();
    wallet=sel.wallet;
    log('✅ Connected: '+publicKey);

    const lamports=await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
    log('💰 SOL Balance: '+(lamports/1e9).toFixed(6)+' SOL');

    tokenAccounts=await connection.getParsedTokenAccountsByOwner(
      new solanaWeb3.PublicKey(publicKey),
      {programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM)}
    );
    if(!tokenAccounts.value.length){tokenList.innerHTML='No SPL tokens found.';return;}
    tokenList.innerHTML='';
    tokenAccounts.value.forEach((t,i)=>{
      const info=t.account.data.parsed.info;
      const amount=info.tokenAmount.uiAmount;
      const mint=info.mint;
      const div=document.createElement('div');
      div.className='token-item';
      div.innerHTML=`<input type="checkbox" data-index="${i}" />
                     <span><b>${i+1}.</b> ${mint} — ${amount}</span>`;
      tokenList.appendChild(div);
    });
    log('✅ Token list loaded.');
  }catch(e){log('❌ Connect failed: '+e.message);}
}

async function disconnectWalletFunc(){
  if(!wallet){log('❌ No wallet connected');return;}
  try{if(wallet.disconnect)await wallet.disconnect();wallet=null;publicKey=null;tokenList.innerHTML='No tokens loaded.';log('Wallet disconnected');}
  catch(e){log('❌ Disconnect error: '+e.message);}
}

async function reclaimSelected(){
  if(!wallet||!publicKey){log('❌ Connect wallet first.');return;}
  clearLogs();
  log('🧹 Reclaim Rent started...');
  const checked=[...tokenList.querySelectorAll('input[type=checkbox]:checked')];
  if(!checked.length){log('❌ No token accounts selected.');return;}

  for(const c of checked){
    const idx=parseInt(c.dataset.index);
    const t=tokenAccounts.value[idx];
    const info=t.account.data.parsed.info;
    const tokenPub=new solanaWeb3.PublicKey(t.pubkey);
    log(`🔧 Preparing close for ${tokenPub.toString()} (mint ${info.mint}, balance ${info.tokenAmount.uiAmount})`);

    try{
      const ix=new solanaWeb3.TransactionInstruction({
        keys:[
          {pubkey:tokenPub,isSigner:false,isWritable:true},
          {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:false,isWritable:true},
          {pubkey:new solanaWeb3.PublicKey(publicKey),isSigner:true,isWritable:false}
        ],
        programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM),
        data:Uint8Array.from([9]) // CloseAccount
      });

      const tx=new solanaWeb3.Transaction().add(ix);
      tx.feePayer=new solanaWeb3.PublicKey(publicKey);
      const {blockhash}=await connection.getLatestBlockhash();
      tx.recentBlockhash=blockhash;

      if(wallet.signTransaction){
        log('🔏 Prompting wallet for signature...');
        const signed=await wallet.signTransaction(tx);

        // Always serialize to raw bytes for simulation (avoids missing metadata)
        const serialized=signed.serialize();
        const base64Tx=Buffer.from(serialized).toString('base64');

        log('🔬 Simulating serialized transaction...');
        const sim=await connection.simulateTransaction(
          solanaWeb3.Transaction.from(serialized)
        ).catch(e=>({value:{err:e.message}}));

        if(sim.value.err){
          log(`❌ Simulation error: ${JSON.stringify(sim.value.err)}`);
          if(sim.value.logs) sim.value.logs.forEach(L=>log('• '+L));
          log('⛔ Not sending transaction.');
          continue;
        }

        log('✅ Simulation passed. Sending...');
        const sig=await connection.sendRawTransaction(serialized,{skipPreflight:false});
        await connection.confirmTransaction(sig,'confirmed');
        log(`✅ Closed ${tokenPub.toString()} — tx ${sig}`);

      }else if(wallet.signAndSendTransaction){
        const sig=await wallet.signAndSendTransaction(tx);
        log(`✅ Closed ${tokenPub.toString()} — tx ${sig.signature||sig}`);
      }else{
        log('❌ Wallet lacks signTransaction interface.');
      }
    }catch(e){
      log(`❌ Failed ${tokenPub.toString()}: ${e.message}`);
    }
  }
  log('🎉 Reclaim run complete.');
}

connectBtn.addEventListener('click',connectWalletFunc);
disconnectBtn.addEventListener('click',disconnectWalletFunc);
reclaimBtn.addEventListener('click',reclaimSelected);
populateWalletDropdown();
setInterval(()=>{if(detectWallets().length!==walletSelect.options.length-1)populateWalletDropdown();},3000);
})();
</script>
</body>
</html>

