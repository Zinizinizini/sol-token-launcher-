<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Universal Solana Wallet DApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  padding: 50px;
  background: #f0f2f5;
}
#walletApp {
  max-width: 600px;
  width: 100%;
  padding: 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  text-align: center;
}
select, button {
  width: 48%;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin: 5px;
}
button {
  background: #4caf50;
  color: white;
}
button:hover {
  background: #45a049;
}
#logs {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  background: #e8f4fd;
  text-align: left;
  white-space: pre-wrap;
  max-height: 400px;
  overflow-y: auto;
}
</style>
</head>
<body>
<div id="walletApp">
  <h2>Universal Solana Wallet DApp</h2>
  <select id="walletSelect">
    <option value="">Select Wallet</option>
  </select>
  <div>
    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet">Disconnect Wallet</button>
  </div>
  <div id="logs">Logs will appear here...</div>
</div>

<!-- ‚úÖ Reliable Solana Web3.js CDN -->
<script src="https://unpkg.com/@solana/web3.js@1.91.0/dist/web3.min.js"></script>

<script>
(async () => {
  // üïê Wait until web3.js is fully loaded
  while (!(window.solanaWeb3 || window.web3 || window.web3js)) {
    console.log('Waiting for Solana Web3.js to load...');
    await new Promise(r => setTimeout(r, 200));
  }

  // Use whichever global name the library exposes
  const web3 = window.solanaWeb3 || window.web3 || window.web3js;
  console.log('‚úÖ Solana Web3.js loaded:', web3);

  const logsEl = document.getElementById('logs');
  const walletSelect = document.getElementById('walletSelect');
  const connectBtn = document.getElementById('connectWallet');
  const disconnectBtn = document.getElementById('disconnectWallet');

  let wallet = null;
  let publicKey = null;

  function logStep(msg) {
    logsEl.innerText += msg + '\n';
    logsEl.scrollTop = logsEl.scrollHeight;
  }

  // üîç Detect available wallets
  function detectWallets() {
    const detected = [];
    if (window.solana?.isPhantom)
      detected.push({ wallet: window.solana, name: 'Phantom' });
    if (window.solflare?.isSolflare)
      detected.push({ wallet: window.solflare, name: 'Solflare' });
    if (window.Slope)
      detected.push({ wallet: new window.Slope(), name: 'Slope' });
    return detected;
  }

  // üß© Populate wallet dropdown
  function populateWalletDropdown() {
    const detectedWallets = detectWallets();
    detectedWallets.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w.name;
      opt.textContent = w.name;
      walletSelect.appendChild(opt);
    });

    if (detectedWallets.length === 0) {
      logStep('‚ùå No wallets detected. Please install Phantom, Solflare, or Slope.');
    } else {
      logStep('Detected wallets: ' + detectedWallets.map(w => w.name).join(', '));
    }
  }

  window.addEventListener('load', populateWalletDropdown);

  function getSelectedWallet() {
    const selected = walletSelect.value;
    return detectWallets().find(w => w.name === selected);
  }

  // ü™ô Connect wallet
  async function connectWalletFunc() {
    logsEl.innerText = '';
    wallet = getSelectedWallet();
    if (!wallet) {
      logStep('‚ùå Please select a wallet first.');
      alert('Select a wallet from the dropdown!');
      return;
    }

    try {
      logStep(`Selected wallet: ${wallet.name}`);
      logStep('Step 1: Connecting wallet...');

      const resp = await wallet.wallet.connect();
      publicKey = resp?.publicKey || wallet.wallet.publicKey;
      if (!publicKey) throw new Error('No public key returned.');
      logStep('Connected: ' + publicKey.toString());

      logStep('Step 2: Creating Solana connection...');
      const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'), 'confirmed');

      logStep('Step 3: Fetching SOL balance...');
      const lamports = await connection.getBalance(publicKey);
      logStep('üí∞ SOL Balance: ' + (lamports / 1e9).toFixed(6) + ' SOL');

      logStep('Step 4: Fetching SPL tokens...');
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        publicKey,
        { programId: new web3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
      );

      if (tokenAccounts.value.length === 0) {
        logStep('No SPL tokens found.');
      } else {
        tokenAccounts.value.forEach((t, i) => {
          const info = t.account.data.parsed.info;
          logStep(`${i + 1}. Mint: ${info.mint}, Amount: ${info.tokenAmount.uiAmountString}`);
        });
      }

      logStep('‚úÖ Wallet connection complete.');
    } catch (err) {
      logStep('‚ùå Error: ' + err.message);
      console.error(err);
    }
  }

  // üîå Disconnect wallet
  async function disconnectWalletFunc() {
    if (!wallet) {
      logStep('‚ùå No wallet connected.');
      return;
    }
    try {
      await wallet.wallet.disconnect();
      logStep('Wallet ' + wallet.name + ' disconnected.');
      wallet = null;
      publicKey = null;
    } catch (err) {
      logStep('‚ùå Error disconnecting: ' + err.message);
      console.error(err);
    }
  }

  connectBtn.addEventListener('click', connectWalletFunc);
  disconnectBtn.addEventListener('click', disconnectWalletFunc);
})();
</script>

</body>
</html>
